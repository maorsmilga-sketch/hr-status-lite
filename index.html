<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>עדכון סטטוס</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(180deg, #e8f0ff 0%, #ffffff 100%) fixed;
      color: #222;
      padding: 30px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      text-align: center;
      margin-bottom: 10px;
    }
    header img {
      width: 90px;
      height: auto;
      display: block;
      margin: 0 auto 5px;
    }
    header h1 {
      color: #1976d2;
      font-size: 26px;
      margin: 0;
      text-shadow: 1px 1px 2px #00000020;
    }
    .wrap {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      border-radius: 14px;
      padding: 25px 30px;
      max-width: 520px;
      width: 100%;
    }
    label {display:block;margin-top:16px;font-weight:bold}
    select,input,button{
      font-size:16px;margin-top:6px;padding:10px;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc
    }
    button{background:#1976d2;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-top:18px}
    button.secondary{background:#0d6efd20;color:#0d6efd;border:1px solid #0d6efd}
    button:hover{filter:brightness(0.95)}
    .hint{font-size:12px;color:#666}
    .statusbar{
      background:#fff;border:1px solid #e5e9f2;border-radius:8px;padding:10px;margin:0 auto 14px;
      max-width:520px;color:#333;box-shadow:0 2px 4px rgba(0,0,0,0.05)
    }
    .statusbar.ok{border-color:#27ae60}
    .statusbar.err{border-color:#c0392b;color:#c0392b}
    .status-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .status-btn{
      flex:1 1 calc(50% - 10px);
      min-width:calc(50% - 10px);
      padding:10px;
      border-radius:10px;
      border:1px solid #e0e0e0;
      cursor:pointer;
      text-align:center;
      user-select:none;
      transition:transform .05s ease, box-shadow .1s ease;
      background:#fff;
      color:#222;
      font-weight:bold;
    }
    .status-btn:hover{transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .status-btn.selected{outline:3px solid #00000022}
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="לוגו">
    <h1>עדכון סטטוס</h1>
  </header>

  <div id="status" class="statusbar">טוען…</div>

  <div class="wrap">
    <label>קבוצה:
      <select id="group"></select>
    </label>

    <label>שם:
      <select id="user"></select>
    </label>
    <div class="hint">המערכת תזכור את הבחירה לפעם הבאה.</div>

    <label>סטטוס:</label>
    <div id="statusButtons" class="status-grid"></div>

    <label>התחלה:</label>
    <div style="display:flex;gap:8px">
      <input type="datetime-local" id="start_time" />
      <button id="start_now" type="button" class="secondary" style="width:40%">התחל מעכשיו</button>
    </div>

    <label>סיום (אופציונלי):</label>
    <input type="datetime-local" id="end_time" />

    <button id="save">שמור</button>
  </div>

  <script src="config.js"></script>
  <script>
    const bar=document.getElementById('status'),gSel=document.getElementById('group'),
    uSel=document.getElementById('user'),statusBtnsWrap=document.getElementById('statusButtons'),
    start=document.getElementById('start_time'),endI=document.getElementById('end_time'),
    nowBt=document.getElementById('start_now'),saveB=document.getElementById('save');
    let selectedStatusCode=null;
    function setBar(msg,ok=null){bar.textContent=msg;bar.classList.remove('ok','err');if(ok===true)bar.classList.add('ok');if(ok===false)bar.classList.add('err');}
    function isoLocalMinutes(d){const pad=n=>String(n).padStart(2,'0');return`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;}
    function loadProfile(){try{const g=localStorage.getItem('selectedGroup'),u=localStorage.getItem('selectedUser');if(g&&[...gSel.options].some(o=>o.value===g))gSel.value=g;if(u&&[...uSel.options].some(o=>o.value===u))uSel.value=u;}catch(_){}}function saveProfile(){localStorage.setItem('selectedGroup',gSel.value);localStorage.setItem('selectedUser',uSel.value);}
    function setSaveEnabled(e){saveB.disabled=!e;saveB.style.opacity=e?'1':'0.6';saveB.style.cursor=e?'pointer':'not-allowed';}
    function jsonp(p,a={}){return new Promise((r,j)=>{if(!window.APP_CONFIG)return j(new Error('config.js missing'));const c='cb_'+Math.random().toString(36).slice(2);a.secret=window.APP_CONFIG.SECRET;a.path=p;a.callback=c;const u=new URL(window.APP_CONFIG.API_URL);Object.entries(a).forEach(([k,v])=>u.searchParams.set(k,v));const s=document.createElement('script');s.src=u.toString();s.onerror=()=>{delete window[c];j(new Error('JSONP load error'));};window[c]=d=>{delete window[c];s.remove();r(d);};document.body.appendChild(s);});}
    async function apiGet(p,a={}){const r=await jsonp(p,a);if(!r.ok){setBar('API error: '+(r.error||'לא ידוע'),false);throw new Error(r.error||'API');}return r;}
    async function apiCreateEvent(p){const r=await jsonp('create_event',{user:p.user,group:p.group,status_code:p.status_code,starts_at:p.starts_at,ends_at:p.ends_at||'',source:p.source||'user'});if(!r.ok){setBar('API error: '+(r.error||'לא ידוע'),false);throw new Error(r.error||'API');}return r;}
    function luminance(h){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h||'');if(!m)return 1;const r=parseInt(m[1],16)/255,g=parseInt(m[2],16)/255,b=parseInt(m[3],16)/255,a=[r,g,b].map(v=>v<=0.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4));return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2];}
    function textColorFor(b){return luminance(b)>0.5?'#000':'#fff';}
    function renderStatusButtons(s){statusBtnsWrap.innerHTML='';s.forEach(st=>{const b=document.createElement('div');b.className='status-btn';b.textContent=st.label;const bg=st.color_hex||'#e0e0e0';b.style.background=bg;b.style.color=textColorFor(bg);b.style.borderColor=bg;b.onclick=()=>{selectedStatusCode=st.code;[...statusBtnsWrap.children].forEach(el=>el.classList.remove('selected'));b.classList.add('selected');setSaveEnabled(true);};statusBtnsWrap.appendChild(b);});selectedStatusCode=null;setSaveEnabled(false);}
    async function loadGroups(){setBar('טוען קבוצות…');const r=await apiGet('users');const u=r.data||[];const g=[...new Set(u.map(x=>String(x.group||'').trim()))].filter(Boolean);gSel.innerHTML='';g.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;gSel.appendChild(o);});if(g.length===0)setBar('לא נמצאו קבוצות',false);else setBar('קבוצות נטענו',true);}
    async function loadStatuses(){setBar('טוען סטטוסים…');const r=await apiGet('statuses');renderStatusButtons(r.data||[]);setBar('סטטוסים נטענו',true);}
    async function loadUsersByGroup(){setBar('טוען משתמשים…');const r=await apiGet('users',{group:gSel.value});const l=r.data||[];uSel.innerHTML='';l.forEach(u=>{const o=document.createElement('option');o.value=u.display_name;o.textContent=u.display_name;uSel.appendChild(o);});if(l.length===0)setBar('אין משתמשים לקבוצה',false);else setBar('',true);loadProfile();}
    nowBt.onclick=()=>{start.value=isoLocalMinutes(new Date());};
    saveB.onclick=async()=>{if(!selectedStatusCode){setBar('בחר סטטוס לפני שמירה',false);return;}saveProfile();setBar('שומר…');try{await apiCreateEvent({user:uSel.value,group:gSel.value,status_code:selectedStatusCode,starts_at:start.value?new Date(start.value).toISOString():new Date().toISOString(),ends_at:endI.value?new Date(endI.value).toISOString():'',source:'user'});setBar('עודכן בהצלחה ✔',true);}catch(e){setBar('שגיאה בשמירה: '+e.message,false);alert('שגיאה: '+e.message);}};
    gSel.onchange=loadUsersByGroup;
    (async function(){try{start.value=isoLocalMinutes(new Date());await loadGroups();await loadStatuses();await loadUsersByGroup();}catch(e){setBar('שגיאה באתחול: '+e.message,false);console.error(e);}})();
  </script>
</body>
</html>
