<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>עדכון סטטוס</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      color: #222;
      text-align: center;
      padding: 30px;
    }
    h1 {
      color: #1976d2;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    select, input, button {
      font-size: 16px;
      margin-top: 5px;
      padding: 8px;
      width: 250px;
      max-width: 90%;
    }
    button {
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background-color: #125ca1;
    }
  </style>
</head>
<body>
  <h1>עדכון סטטוס</h1>

  <label>קבוצה:
    <select id="group"></select>
  </label>

  <label>שם:
    <select id="user"></select>
  </label>
  <small>המערכת תזכור את הבחירה לפעם הבאה.</small>

  <label>סטטוס:
    <select id="status"></select>
  </label>

  <label>התחלה:
    <input type="datetime-local" id="start_time" />
    <button id="start_now" type="button">התחל מעכשיו</button>
  </label>

  <label>סיום (אופציונלי):
    <input type="datetime-local" id="end_time" />
  </label>

  <button id="save">שמור</button>

  <script src="config.js"></script>
  <script>
    const gSel = document.getElementById('group');
    const uSel = document.getElementById('user');
    const sSel = document.getElementById('status');
    const startInput = document.getElementById('start_time');
    const endInput = document.getElementById('end_time');
    const startNowBtn = document.getElementById('start_now');
    const saveBtn = document.getElementById('save');

    const API = window.APP_CONFIG.API_URL;
    const SECRET = window.APP_CONFIG.SECRET;

    async function apiGet(path, params={}) {
      const query = new URLSearchParams({...params, secret: SECRET});
      const r = await fetch(`${API}?path=${path}&${query}`);
      return r.json();
    }

    async function apiPost(path, body={}) {
      const r = await fetch(`${API}?path=${path}&secret=${SECRET}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      return r.json();
    }

    // פונקציה חדשה: טעינת קבוצות דינמית מתוך הגיליון
    async function loadGroupsDynamic(){
      const res = await apiGet('users'); // בלי פילטר
      const users = res.data || [];
      const groups = [...new Set(users.map(u => String(u.group || '').trim()))].filter(Boolean);
      gSel.innerHTML = '';
      groups.forEach(g=>{
        const o = document.createElement('option');
        o.value = g;
        o.textContent = g;
        gSel.appendChild(o);
      });
    }

    async function loadStatuses(){
      const res = await apiGet('statuses');
      const statuses = res.data || [];
      sSel.innerHTML = '';
      statuses.forEach(s=>{
        const o = document.createElement('option');
        o.value = s.code;
        o.textContent = s.label;
        sSel.appendChild(o);
      });
    }

    async function loadUsers(){
      const group = gSel.value;
      const res = await apiGet('users', {group});
      const users = res.data || [];
      uSel.innerHTML = '';
      users.forEach(u=>{
        const o = document.createElement('option');
        o.value = u.display_name;
        o.textContent = u.display_name;
        uSel.appendChild(o);
      });
      loadProfile();
    }

    function loadProfile(){
      const savedUser = localStorage.getItem('selectedUser');
      const savedGroup = localStorage.getItem('selectedGroup');
      if(savedGroup && [...gSel.options].some(o=>o.value===savedGroup)){
        gSel.value = savedGroup;
      }
      if(savedUser && [...uSel.options].some(o=>o.value===savedUser)){
        uSel.value = savedUser;
      }
    }

    function saveProfile(){
      localStorage.setItem('selectedUser', uSel.value);
      localStorage.setItem('selectedGroup', gSel.value);
    }

    startNowBtn.onclick = ()=>{
      const now = new Date();
      const local = now.toISOString().slice(0,16);
      startInput.value = local;
    };

    saveBtn.onclick = async ()=>{
      const payload = {
        display_name: uSel.value,
        group: gSel.value,
        status_code: sSel.value,
        start_time: startInput.value,
        end_time: endInput.value
      };
      saveProfile();
      const res = await apiPost('event', payload);
      alert(res.ok ? 'עודכן בהצלחה!' : 'שגיאה בעדכון');
    };

    gSel.onchange = loadUsers;

    (async function init(){
      await loadGroupsDynamic();
      await loadStatuses();
      await loadUsers();
    })();
  </script>
</body>
</html>
